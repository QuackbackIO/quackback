/**
 * Auto-generated migration SQL for tenant provisioning
 *
 * DO NOT EDIT MANUALLY - regenerate with:
 *   bun packages/db/scripts/generate-init-sql.ts
 *
 * Generated: 2026-01-30T11:38:40.211Z
 * Migrations: 14
 */

export interface Migration {
  /** Migration name/tag (e.g., "0000_initial") */
  tag: string
  /** Timestamp when migration was created */
  when: number
  /** SHA-256 hash of SQL content (for drizzle tracking) */
  hash: string
  /** Raw SQL content */
  sql: string
}

/**
 * All migrations in order, ready to be applied to a new tenant database.
 * Each migration's SQL may contain multiple statements separated by
 * '--> statement-breakpoint' markers.
 */
export const MIGRATIONS: Migration[] = [
  {
    tag: '0000_initial',
    when: 1767020259985,
    hash: '057cad44de21fc8d3bcb60d2240eec9f5d6eadafa6d7f427faea3485dfc87e31',
    sql: 'CREATE TABLE "account" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"account_id" text NOT NULL,\n\t"provider_id" text NOT NULL,\n\t"user_id" uuid NOT NULL,\n\t"access_token" text,\n\t"refresh_token" text,\n\t"id_token" text,\n\t"access_token_expires_at" timestamp with time zone,\n\t"refresh_token_expires_at" timestamp with time zone,\n\t"scope" text,\n\t"password" text,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "invitation" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"email" text NOT NULL,\n\t"name" text,\n\t"role" text,\n\t"status" text DEFAULT \'pending\' NOT NULL,\n\t"expires_at" timestamp with time zone NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"last_sent_at" timestamp with time zone,\n\t"inviter_id" uuid NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "member" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"user_id" uuid NOT NULL,\n\t"role" text DEFAULT \'member\' NOT NULL,\n\t"created_at" timestamp with time zone NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "one_time_token" (\n\t"id" text PRIMARY KEY NOT NULL,\n\t"token" text NOT NULL,\n\t"user_id" uuid NOT NULL,\n\t"expires_at" timestamp with time zone NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "session" (\n\t"id" text PRIMARY KEY NOT NULL,\n\t"expires_at" timestamp with time zone NOT NULL,\n\t"token" text NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone NOT NULL,\n\t"ip_address" text,\n\t"user_agent" text,\n\t"user_id" uuid NOT NULL,\n\tCONSTRAINT "session_token_unique" UNIQUE("token")\n);\n--> statement-breakpoint\nCREATE TABLE "settings" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"name" text NOT NULL,\n\t"slug" text NOT NULL,\n\t"logo_blob" "bytea",\n\t"logo_type" text,\n\t"favicon_blob" "bytea",\n\t"favicon_type" text,\n\t"header_logo_blob" "bytea",\n\t"header_logo_type" text,\n\t"created_at" timestamp with time zone NOT NULL,\n\t"metadata" text,\n\t"auth_config" text,\n\t"portal_config" text,\n\t"branding_config" text,\n\t"custom_css" text,\n\t"header_display_mode" text DEFAULT \'logo_and_name\',\n\t"header_display_name" text,\n\tCONSTRAINT "settings_slug_unique" UNIQUE("slug")\n);\n--> statement-breakpoint\nCREATE TABLE "user" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"name" text NOT NULL,\n\t"email" text NOT NULL,\n\t"email_verified" boolean DEFAULT false NOT NULL,\n\t"image" text,\n\t"image_blob" "bytea",\n\t"image_type" text,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"metadata" text\n);\n--> statement-breakpoint\nCREATE TABLE "verification" (\n\t"id" text PRIMARY KEY NOT NULL,\n\t"identifier" text NOT NULL,\n\t"value" text NOT NULL,\n\t"expires_at" timestamp with time zone NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone DEFAULT now() NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "boards" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"slug" text NOT NULL,\n\t"name" text NOT NULL,\n\t"description" text,\n\t"is_public" boolean DEFAULT true NOT NULL,\n\t"settings" jsonb DEFAULT \'{}\'::jsonb NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone DEFAULT now() NOT NULL,\n\tCONSTRAINT "boards_slug_unique" UNIQUE("slug")\n);\n--> statement-breakpoint\nCREATE TABLE "roadmaps" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"slug" text NOT NULL,\n\t"name" text NOT NULL,\n\t"description" text,\n\t"is_public" boolean DEFAULT true NOT NULL,\n\t"position" integer DEFAULT 0 NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone DEFAULT now() NOT NULL,\n\tCONSTRAINT "roadmaps_slug_unique" UNIQUE("slug")\n);\n--> statement-breakpoint\nCREATE TABLE "tags" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"name" text NOT NULL,\n\t"color" text DEFAULT \'#6b7280\' NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\tCONSTRAINT "tags_name_unique" UNIQUE("name")\n);\n--> statement-breakpoint\nCREATE TABLE "post_statuses" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"name" text NOT NULL,\n\t"slug" text NOT NULL,\n\t"color" text DEFAULT \'#6b7280\' NOT NULL,\n\t"category" text DEFAULT \'active\' NOT NULL,\n\t"position" integer DEFAULT 0 NOT NULL,\n\t"show_on_roadmap" boolean DEFAULT false NOT NULL,\n\t"is_default" boolean DEFAULT false NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\tCONSTRAINT "post_statuses_slug_unique" UNIQUE("slug")\n);\n--> statement-breakpoint\nCREATE TABLE "comment_edit_history" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"comment_id" uuid NOT NULL,\n\t"editor_member_id" uuid NOT NULL,\n\t"previous_content" text NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "comment_reactions" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"comment_id" uuid NOT NULL,\n\t"user_identifier" text NOT NULL,\n\t"emoji" text NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "comments" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"post_id" uuid NOT NULL,\n\t"parent_id" uuid,\n\t"member_id" uuid,\n\t"author_id" text,\n\t"author_name" text,\n\t"author_email" text,\n\t"content" text NOT NULL,\n\t"is_team_member" boolean DEFAULT false NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"deleted_at" timestamp with time zone\n);\n--> statement-breakpoint\nCREATE TABLE "post_edit_history" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"post_id" uuid NOT NULL,\n\t"editor_member_id" uuid NOT NULL,\n\t"previous_title" text NOT NULL,\n\t"previous_content" text NOT NULL,\n\t"previous_content_json" jsonb,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "post_roadmaps" (\n\t"post_id" uuid NOT NULL,\n\t"roadmap_id" uuid NOT NULL,\n\t"position" integer DEFAULT 0 NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "post_tags" (\n\t"post_id" uuid NOT NULL,\n\t"tag_id" uuid NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "posts" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"board_id" uuid NOT NULL,\n\t"title" text NOT NULL,\n\t"content" text NOT NULL,\n\t"content_json" jsonb,\n\t"member_id" uuid,\n\t"author_id" text,\n\t"author_name" text,\n\t"author_email" text,\n\t"status_id" uuid,\n\t"owner_member_id" uuid,\n\t"owner_id" text,\n\t"vote_count" integer DEFAULT 0 NOT NULL,\n\t"comment_count" integer DEFAULT 0 NOT NULL,\n\t"official_response" text,\n\t"official_response_member_id" uuid,\n\t"official_response_author_id" text,\n\t"official_response_author_name" text,\n\t"official_response_at" timestamp with time zone,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"deleted_at" timestamp with time zone,\n\t"deleted_by_member_id" uuid,\n\t"search_vector" "tsvector" GENERATED ALWAYS AS (setweight(to_tsvector(\'english\', coalesce(title, \'\')), \'A\') || setweight(to_tsvector(\'english\', coalesce(content, \'\')), \'B\')) STORED,\n\tCONSTRAINT "vote_count_non_negative" CHECK (vote_count >= 0),\n\tCONSTRAINT "comment_count_non_negative" CHECK (comment_count >= 0)\n);\n--> statement-breakpoint\nCREATE TABLE "votes" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"post_id" uuid NOT NULL,\n\t"user_identifier" text NOT NULL,\n\t"member_id" uuid,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone DEFAULT now() NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "integration_event_mappings" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"integration_id" uuid NOT NULL,\n\t"event_type" varchar(100) NOT NULL,\n\t"action_type" varchar(50) NOT NULL,\n\t"action_config" jsonb DEFAULT \'{}\'::jsonb NOT NULL,\n\t"filters" jsonb,\n\t"enabled" boolean DEFAULT true NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone DEFAULT now() NOT NULL,\n\tCONSTRAINT "mapping_unique" UNIQUE("integration_id","event_type","action_type")\n);\n--> statement-breakpoint\nCREATE TABLE "integrations" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"integration_type" varchar(50) NOT NULL,\n\t"status" varchar(20) DEFAULT \'pending\' NOT NULL,\n\t"access_token_encrypted" text,\n\t"refresh_token_encrypted" text,\n\t"token_expires_at" timestamp with time zone,\n\t"config" jsonb DEFAULT \'{}\'::jsonb NOT NULL,\n\t"external_workspace_id" varchar(255),\n\t"external_workspace_name" varchar(255),\n\t"connected_by_member_id" uuid,\n\t"connected_at" timestamp with time zone,\n\t"last_sync_at" timestamp with time zone,\n\t"last_error" text,\n\t"last_error_at" timestamp with time zone,\n\t"error_count" integer DEFAULT 0 NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone DEFAULT now() NOT NULL,\n\tCONSTRAINT "integration_type_unique" UNIQUE("integration_type"),\n\tCONSTRAINT "error_count_non_negative" CHECK (error_count >= 0)\n);\n--> statement-breakpoint\nCREATE TABLE "changelog_entries" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"board_id" uuid NOT NULL,\n\t"title" text NOT NULL,\n\t"content" text NOT NULL,\n\t"published_at" timestamp with time zone,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone DEFAULT now() NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "notification_preferences" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"member_id" uuid NOT NULL,\n\t"email_status_change" boolean DEFAULT true NOT NULL,\n\t"email_new_comment" boolean DEFAULT true NOT NULL,\n\t"email_muted" boolean DEFAULT false NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone DEFAULT now() NOT NULL,\n\tCONSTRAINT "notification_preferences_member_id_unique" UNIQUE("member_id")\n);\n--> statement-breakpoint\nCREATE TABLE "post_subscriptions" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"post_id" uuid NOT NULL,\n\t"member_id" uuid NOT NULL,\n\t"reason" varchar(20) NOT NULL,\n\t"muted" boolean DEFAULT false NOT NULL,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone DEFAULT now() NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "unsubscribe_tokens" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"token" text NOT NULL,\n\t"member_id" uuid NOT NULL,\n\t"post_id" uuid,\n\t"action" varchar(30) NOT NULL,\n\t"expires_at" timestamp with time zone NOT NULL,\n\t"used_at" timestamp with time zone,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\tCONSTRAINT "unsubscribe_tokens_token_unique" UNIQUE("token")\n);\n--> statement-breakpoint\nALTER TABLE "account" ADD CONSTRAINT "account_user_id_user_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."user"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "invitation" ADD CONSTRAINT "invitation_inviter_id_user_id_fk" FOREIGN KEY ("inviter_id") REFERENCES "public"."user"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "member" ADD CONSTRAINT "member_user_id_user_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."user"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "one_time_token" ADD CONSTRAINT "one_time_token_user_id_user_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."user"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "session" ADD CONSTRAINT "session_user_id_user_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."user"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "comment_edit_history" ADD CONSTRAINT "comment_edit_history_comment_id_comments_id_fk" FOREIGN KEY ("comment_id") REFERENCES "public"."comments"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "comment_edit_history" ADD CONSTRAINT "comment_edit_history_editor_member_id_member_id_fk" FOREIGN KEY ("editor_member_id") REFERENCES "public"."member"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "comment_reactions" ADD CONSTRAINT "comment_reactions_comment_id_comments_id_fk" FOREIGN KEY ("comment_id") REFERENCES "public"."comments"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "comments" ADD CONSTRAINT "comments_post_id_posts_id_fk" FOREIGN KEY ("post_id") REFERENCES "public"."posts"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "comments" ADD CONSTRAINT "comments_member_id_member_id_fk" FOREIGN KEY ("member_id") REFERENCES "public"."member"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "post_edit_history" ADD CONSTRAINT "post_edit_history_post_id_posts_id_fk" FOREIGN KEY ("post_id") REFERENCES "public"."posts"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "post_edit_history" ADD CONSTRAINT "post_edit_history_editor_member_id_member_id_fk" FOREIGN KEY ("editor_member_id") REFERENCES "public"."member"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "post_roadmaps" ADD CONSTRAINT "post_roadmaps_post_id_posts_id_fk" FOREIGN KEY ("post_id") REFERENCES "public"."posts"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "post_roadmaps" ADD CONSTRAINT "post_roadmaps_roadmap_id_roadmaps_id_fk" FOREIGN KEY ("roadmap_id") REFERENCES "public"."roadmaps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "post_tags" ADD CONSTRAINT "post_tags_post_id_posts_id_fk" FOREIGN KEY ("post_id") REFERENCES "public"."posts"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "post_tags" ADD CONSTRAINT "post_tags_tag_id_tags_id_fk" FOREIGN KEY ("tag_id") REFERENCES "public"."tags"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "posts" ADD CONSTRAINT "posts_board_id_boards_id_fk" FOREIGN KEY ("board_id") REFERENCES "public"."boards"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "posts" ADD CONSTRAINT "posts_member_id_member_id_fk" FOREIGN KEY ("member_id") REFERENCES "public"."member"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "posts" ADD CONSTRAINT "posts_status_id_post_statuses_id_fk" FOREIGN KEY ("status_id") REFERENCES "public"."post_statuses"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "posts" ADD CONSTRAINT "posts_owner_member_id_member_id_fk" FOREIGN KEY ("owner_member_id") REFERENCES "public"."member"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "posts" ADD CONSTRAINT "posts_official_response_member_id_member_id_fk" FOREIGN KEY ("official_response_member_id") REFERENCES "public"."member"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "posts" ADD CONSTRAINT "posts_deleted_by_member_id_member_id_fk" FOREIGN KEY ("deleted_by_member_id") REFERENCES "public"."member"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "votes" ADD CONSTRAINT "votes_post_id_posts_id_fk" FOREIGN KEY ("post_id") REFERENCES "public"."posts"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "votes" ADD CONSTRAINT "votes_member_id_member_id_fk" FOREIGN KEY ("member_id") REFERENCES "public"."member"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "integration_event_mappings" ADD CONSTRAINT "event_mappings_integration_fk" FOREIGN KEY ("integration_id") REFERENCES "public"."integrations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "integrations" ADD CONSTRAINT "integrations_connected_by_member_id_member_id_fk" FOREIGN KEY ("connected_by_member_id") REFERENCES "public"."member"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "changelog_entries" ADD CONSTRAINT "changelog_entries_board_id_boards_id_fk" FOREIGN KEY ("board_id") REFERENCES "public"."boards"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "notification_preferences" ADD CONSTRAINT "notification_preferences_member_id_member_id_fk" FOREIGN KEY ("member_id") REFERENCES "public"."member"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "post_subscriptions" ADD CONSTRAINT "post_subscriptions_post_id_posts_id_fk" FOREIGN KEY ("post_id") REFERENCES "public"."posts"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "post_subscriptions" ADD CONSTRAINT "post_subscriptions_member_id_member_id_fk" FOREIGN KEY ("member_id") REFERENCES "public"."member"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "unsubscribe_tokens" ADD CONSTRAINT "unsubscribe_tokens_member_id_member_id_fk" FOREIGN KEY ("member_id") REFERENCES "public"."member"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "unsubscribe_tokens" ADD CONSTRAINT "unsubscribe_tokens_post_id_posts_id_fk" FOREIGN KEY ("post_id") REFERENCES "public"."posts"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nCREATE INDEX "account_userId_idx" ON "account" USING btree ("user_id");--> statement-breakpoint\nCREATE INDEX "invitation_email_idx" ON "invitation" USING btree ("email");--> statement-breakpoint\nCREATE INDEX "invitation_email_status_idx" ON "invitation" USING btree ("email","status");--> statement-breakpoint\nCREATE INDEX "member_userId_idx" ON "member" USING btree ("user_id");--> statement-breakpoint\nCREATE UNIQUE INDEX "member_user_idx" ON "member" USING btree ("user_id");--> statement-breakpoint\nCREATE INDEX "member_role_idx" ON "member" USING btree ("role");--> statement-breakpoint\nCREATE INDEX "session_userId_idx" ON "session" USING btree ("user_id");--> statement-breakpoint\nCREATE UNIQUE INDEX "user_email_idx" ON "user" USING btree ("email");--> statement-breakpoint\nCREATE INDEX "verification_identifier_idx" ON "verification" USING btree ("identifier");--> statement-breakpoint\nCREATE UNIQUE INDEX "boards_slug_idx" ON "boards" USING btree ("slug");--> statement-breakpoint\nCREATE UNIQUE INDEX "roadmaps_slug_idx" ON "roadmaps" USING btree ("slug");--> statement-breakpoint\nCREATE INDEX "roadmaps_position_idx" ON "roadmaps" USING btree ("position");--> statement-breakpoint\nCREATE UNIQUE INDEX "tags_name_idx" ON "tags" USING btree ("name");--> statement-breakpoint\nCREATE UNIQUE INDEX "post_statuses_slug_idx" ON "post_statuses" USING btree ("slug");--> statement-breakpoint\nCREATE INDEX "post_statuses_position_idx" ON "post_statuses" USING btree ("category","position");--> statement-breakpoint\nCREATE INDEX "comment_edit_history_comment_id_idx" ON "comment_edit_history" USING btree ("comment_id");--> statement-breakpoint\nCREATE INDEX "comment_edit_history_created_at_idx" ON "comment_edit_history" USING btree ("created_at");--> statement-breakpoint\nCREATE INDEX "comment_reactions_comment_id_idx" ON "comment_reactions" USING btree ("comment_id");--> statement-breakpoint\nCREATE UNIQUE INDEX "comment_reactions_unique_idx" ON "comment_reactions" USING btree ("comment_id","user_identifier","emoji");--> statement-breakpoint\nCREATE INDEX "comments_post_id_idx" ON "comments" USING btree ("post_id");--> statement-breakpoint\nCREATE INDEX "comments_parent_id_idx" ON "comments" USING btree ("parent_id");--> statement-breakpoint\nCREATE INDEX "comments_member_id_idx" ON "comments" USING btree ("member_id");--> statement-breakpoint\nCREATE INDEX "comments_created_at_idx" ON "comments" USING btree ("created_at");--> statement-breakpoint\nCREATE INDEX "comments_post_created_at_idx" ON "comments" USING btree ("post_id","created_at");--> statement-breakpoint\nCREATE INDEX "post_edit_history_post_id_idx" ON "post_edit_history" USING btree ("post_id");--> statement-breakpoint\nCREATE INDEX "post_edit_history_created_at_idx" ON "post_edit_history" USING btree ("created_at");--> statement-breakpoint\nCREATE UNIQUE INDEX "post_roadmaps_pk" ON "post_roadmaps" USING btree ("post_id","roadmap_id");--> statement-breakpoint\nCREATE INDEX "post_roadmaps_post_id_idx" ON "post_roadmaps" USING btree ("post_id");--> statement-breakpoint\nCREATE INDEX "post_roadmaps_roadmap_id_idx" ON "post_roadmaps" USING btree ("roadmap_id");--> statement-breakpoint\nCREATE INDEX "post_roadmaps_position_idx" ON "post_roadmaps" USING btree ("roadmap_id","position");--> statement-breakpoint\nCREATE UNIQUE INDEX "post_tags_pk" ON "post_tags" USING btree ("post_id","tag_id");--> statement-breakpoint\nCREATE INDEX "post_tags_post_id_idx" ON "post_tags" USING btree ("post_id");--> statement-breakpoint\nCREATE INDEX "post_tags_tag_id_idx" ON "post_tags" USING btree ("tag_id");--> statement-breakpoint\nCREATE INDEX "posts_board_id_idx" ON "posts" USING btree ("board_id");--> statement-breakpoint\nCREATE INDEX "posts_status_id_idx" ON "posts" USING btree ("status_id");--> statement-breakpoint\nCREATE INDEX "posts_member_id_idx" ON "posts" USING btree ("member_id");--> statement-breakpoint\nCREATE INDEX "posts_owner_member_id_idx" ON "posts" USING btree ("owner_member_id");--> statement-breakpoint\nCREATE INDEX "posts_owner_id_idx" ON "posts" USING btree ("owner_id");--> statement-breakpoint\nCREATE INDEX "posts_created_at_idx" ON "posts" USING btree ("created_at");--> statement-breakpoint\nCREATE INDEX "posts_vote_count_idx" ON "posts" USING btree ("vote_count");--> statement-breakpoint\nCREATE INDEX "posts_board_vote_idx" ON "posts" USING btree ("board_id","vote_count");--> statement-breakpoint\nCREATE INDEX "posts_board_created_at_idx" ON "posts" USING btree ("board_id","created_at");--> statement-breakpoint\nCREATE INDEX "posts_board_status_idx" ON "posts" USING btree ("board_id","status_id");--> statement-breakpoint\nCREATE INDEX "posts_member_created_at_idx" ON "posts" USING btree ("member_id","created_at");--> statement-breakpoint\nCREATE INDEX "posts_with_status_idx" ON "posts" USING btree ("status_id","vote_count") WHERE status_id IS NOT NULL;--> statement-breakpoint\nCREATE INDEX "posts_search_vector_idx" ON "posts" USING gin ("search_vector");--> statement-breakpoint\nCREATE INDEX "posts_deleted_at_idx" ON "posts" USING btree ("deleted_at");--> statement-breakpoint\nCREATE INDEX "posts_board_deleted_at_idx" ON "posts" USING btree ("board_id","deleted_at");--> statement-breakpoint\nCREATE INDEX "votes_post_id_idx" ON "votes" USING btree ("post_id");--> statement-breakpoint\nCREATE UNIQUE INDEX "votes_unique_idx" ON "votes" USING btree ("post_id","user_identifier");--> statement-breakpoint\nCREATE INDEX "votes_member_id_idx" ON "votes" USING btree ("member_id");--> statement-breakpoint\nCREATE INDEX "votes_member_created_at_idx" ON "votes" USING btree ("member_id","created_at");--> statement-breakpoint\nCREATE INDEX "idx_event_mappings_lookup" ON "integration_event_mappings" USING btree ("integration_id","event_type","enabled");--> statement-breakpoint\nCREATE INDEX "idx_integrations_type_status" ON "integrations" USING btree ("integration_type","status");--> statement-breakpoint\nCREATE INDEX "changelog_board_id_idx" ON "changelog_entries" USING btree ("board_id");--> statement-breakpoint\nCREATE INDEX "changelog_published_at_idx" ON "changelog_entries" USING btree ("published_at");--> statement-breakpoint\nCREATE INDEX "notification_preferences_member_idx" ON "notification_preferences" USING btree ("member_id");--> statement-breakpoint\nCREATE UNIQUE INDEX "post_subscriptions_unique" ON "post_subscriptions" USING btree ("post_id","member_id");--> statement-breakpoint\nCREATE INDEX "post_subscriptions_member_idx" ON "post_subscriptions" USING btree ("member_id");--> statement-breakpoint\nCREATE INDEX "post_subscriptions_post_idx" ON "post_subscriptions" USING btree ("post_id");--> statement-breakpoint\nCREATE INDEX "post_subscriptions_post_active_idx" ON "post_subscriptions" USING btree ("post_id") WHERE muted = false;--> statement-breakpoint\nCREATE INDEX "unsubscribe_tokens_token_idx" ON "unsubscribe_tokens" USING btree ("token");--> statement-breakpoint\nCREATE INDEX "unsubscribe_tokens_member_idx" ON "unsubscribe_tokens" USING btree ("member_id");',
  },
  {
    tag: '0001_add_moderation_state',
    when: 1767978300000,
    hash: '9240b43a6587318099214186ea8728b219051184b24d9c59bb0dab58ee8b58fd',
    sql: '-- Add moderation_state column to posts\nALTER TABLE "posts" ADD COLUMN IF NOT EXISTS "moderation_state" text DEFAULT \'published\' NOT NULL;\n--> statement-breakpoint\nCREATE INDEX IF NOT EXISTS "posts_moderation_state_idx" ON "posts" USING btree ("moderation_state");\n',
  },
  {
    tag: '0002_fair_amazoness',
    when: 1768295956689,
    hash: 'cc5e62879c15cec4bbb7e9fd8ed0aba07ee45296f2820341b871775b9f19a3de',
    sql: 'CREATE TABLE "in_app_notifications" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"member_id" uuid NOT NULL,\n\t"type" varchar(50) NOT NULL,\n\t"title" varchar(255) NOT NULL,\n\t"body" text,\n\t"post_id" uuid,\n\t"comment_id" uuid,\n\t"metadata" jsonb,\n\t"read_at" timestamp with time zone,\n\t"archived_at" timestamp with time zone,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL\n);\n--> statement-breakpoint\nALTER TABLE "in_app_notifications" ADD CONSTRAINT "in_app_notifications_member_id_member_id_fk" FOREIGN KEY ("member_id") REFERENCES "public"."member"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "in_app_notifications" ADD CONSTRAINT "in_app_notifications_post_id_posts_id_fk" FOREIGN KEY ("post_id") REFERENCES "public"."posts"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nALTER TABLE "in_app_notifications" ADD CONSTRAINT "in_app_notifications_comment_id_comments_id_fk" FOREIGN KEY ("comment_id") REFERENCES "public"."comments"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\nCREATE INDEX "in_app_notifications_member_created_idx" ON "in_app_notifications" USING btree ("member_id","created_at");--> statement-breakpoint\nCREATE INDEX "in_app_notifications_member_unread_idx" ON "in_app_notifications" USING btree ("member_id") WHERE read_at IS NULL AND archived_at IS NULL;--> statement-breakpoint\nCREATE INDEX "in_app_notifications_post_idx" ON "in_app_notifications" USING btree ("post_id");',
  },
  {
    tag: '0003_dazzling_bushwacker',
    when: 1768345529636,
    hash: '06f5fefa823bfc45dede3ed7a08e17fe54ea9d34e9c44410732e1407f0672b1d',
    sql: 'CREATE TYPE "public"."cloud_tier" AS ENUM(\'free\', \'pro\', \'team\', \'enterprise\');--> statement-breakpoint\nCREATE TYPE "public"."invoice_status" AS ENUM(\'draft\', \'open\', \'paid\', \'void\', \'uncollectible\');--> statement-breakpoint\nCREATE TYPE "public"."subscription_status" AS ENUM(\'trialing\', \'active\', \'past_due\', \'canceled\', \'unpaid\');--> statement-breakpoint\nCREATE TABLE "billing_subscriptions" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"stripe_customer_id" text NOT NULL,\n\t"stripe_subscription_id" text,\n\t"tier" "cloud_tier" DEFAULT \'free\' NOT NULL,\n\t"status" "subscription_status" DEFAULT \'active\' NOT NULL,\n\t"seats_included" integer DEFAULT 1 NOT NULL,\n\t"seats_additional" integer DEFAULT 0 NOT NULL,\n\t"current_period_start" timestamp with time zone,\n\t"current_period_end" timestamp with time zone,\n\t"cancel_at_period_end" boolean DEFAULT false,\n\t"trial_start" timestamp with time zone,\n\t"trial_end" timestamp with time zone,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"updated_at" timestamp with time zone DEFAULT now() NOT NULL\n);\n--> statement-breakpoint\nCREATE TABLE "invoices" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"stripe_invoice_id" text NOT NULL,\n\t"amount_due" integer NOT NULL,\n\t"amount_paid" integer NOT NULL,\n\t"currency" text DEFAULT \'usd\' NOT NULL,\n\t"status" "invoice_status" NOT NULL,\n\t"invoice_url" text,\n\t"pdf_url" text,\n\t"period_start" timestamp with time zone,\n\t"period_end" timestamp with time zone,\n\t"created_at" timestamp with time zone DEFAULT now() NOT NULL,\n\tCONSTRAINT "invoices_stripe_invoice_id_unique" UNIQUE("stripe_invoice_id")\n);\n--> statement-breakpoint\nCREATE INDEX "subscriptions_stripe_customer_idx" ON "billing_subscriptions" USING btree ("stripe_customer_id");--> statement-breakpoint\nCREATE INDEX "subscriptions_stripe_subscription_idx" ON "billing_subscriptions" USING btree ("stripe_subscription_id");--> statement-breakpoint\nCREATE INDEX "invoices_stripe_invoice_idx" ON "invoices" USING btree ("stripe_invoice_id");',
  },
  {
    tag: '0004_add_ai_features',
    when: 1768515600000,
    hash: '92d67da9b173d661c3a5f8e0757d6f11d400b289c9f3d5d58d4cb5600d388af0',
    sql: '-- Enable pgvector extension for similarity search\nCREATE EXTENSION IF NOT EXISTS vector;--> statement-breakpoint\n\n-- Add embedding columns to posts table\nALTER TABLE "posts" ADD COLUMN "embedding" vector(1536);--> statement-breakpoint\nALTER TABLE "posts" ADD COLUMN "embedding_model" text;--> statement-breakpoint\nALTER TABLE "posts" ADD COLUMN "embedding_updated_at" timestamp with time zone;--> statement-breakpoint\n\n-- Create HNSW index for fast similarity search\n-- Only index non-null embeddings for active (non-deleted) posts\nCREATE INDEX "posts_embedding_idx" ON "posts" USING hnsw ("embedding" vector_cosine_ops)\n  WITH (m = 16, ef_construction = 64)\n  WHERE "embedding" IS NOT NULL AND "deleted_at" IS NULL;--> statement-breakpoint\n\n-- Create post_sentiment table\nCREATE TABLE "post_sentiment" (\n\t"id" uuid PRIMARY KEY NOT NULL,\n\t"post_id" uuid NOT NULL,\n\t"sentiment" text NOT NULL,\n\t"confidence" real NOT NULL,\n\t"model" text NOT NULL,\n\t"processed_at" timestamp with time zone DEFAULT now() NOT NULL,\n\t"input_tokens" integer,\n\t"output_tokens" integer,\n\tCONSTRAINT "post_sentiment_post_id_unique" UNIQUE("post_id"),\n\tCONSTRAINT "post_sentiment_sentiment_check" CHECK (sentiment IN (\'positive\', \'neutral\', \'negative\'))\n);--> statement-breakpoint\n\n-- Add foreign key constraint\nALTER TABLE "post_sentiment" ADD CONSTRAINT "post_sentiment_post_id_posts_id_fk"\n  FOREIGN KEY ("post_id") REFERENCES "posts"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint\n\n-- Create indexes for sentiment queries\nCREATE INDEX "post_sentiment_processed_at_idx" ON "post_sentiment" USING btree ("processed_at");--> statement-breakpoint\nCREATE INDEX "post_sentiment_sentiment_idx" ON "post_sentiment" USING btree ("sentiment");\n',
  },
  {
    tag: '0005_add_performance_indexes',
    when: 1768602000000,
    hash: 'c981e4188ccf6a552afe85b938f9726d3378d1ca42d42f12653078b8c0a304ea',
    sql: '-- Performance optimization indexes\n-- Based on query analysis of common access patterns\n\n-- 1. Posts created_at range queries with board context\n-- Optimizes: WHERE board_id = ? AND created_at > ? AND moderation_state = \'published\'\nCREATE INDEX IF NOT EXISTS "idx_posts_board_created_moderation"\nON "posts" ("board_id", "created_at", "moderation_state");--> statement-breakpoint\n\n-- 2. Comments member filtering for user activity pages\n-- Optimizes: WHERE member_id = ? ORDER BY created_at DESC\nCREATE INDEX IF NOT EXISTS "idx_comments_member_created"\nON "comments" ("member_id", "created_at" DESC);--> statement-breakpoint\n\n-- 3. Partial index for posts with embeddings (semantic search optimization)\n-- Optimizes: WHERE embedding IS NOT NULL queries\nCREATE INDEX IF NOT EXISTS "idx_posts_embedding_exists"\nON "posts" ("id")\nWHERE "embedding" IS NOT NULL;--> statement-breakpoint\n\n-- 4. Changelog published entries by board\n-- Optimizes: WHERE board_id = ? AND published_at IS NOT NULL ORDER BY published_at DESC\nCREATE INDEX IF NOT EXISTS "idx_changelog_board_published"\nON "changelog_entries" ("board_id", "published_at" DESC)\nWHERE "published_at" IS NOT NULL;--> statement-breakpoint\n\n-- 5. Votes duplicate check optimization\n-- Optimizes: WHERE member_id = ? AND post_id = ? (check if user voted)\nCREATE INDEX IF NOT EXISTS "idx_votes_member_post"\nON "votes" ("member_id", "post_id");--> statement-breakpoint\n\n-- 6. In-app notifications unread count/listing optimization\n-- Optimizes: WHERE member_id = ? AND read_at IS NULL ORDER BY created_at DESC\nCREATE INDEX IF NOT EXISTS "idx_notifications_member_unread_created"\nON "in_app_notifications" ("member_id", "created_at" DESC)\nWHERE "read_at" IS NULL;--> statement-breakpoint\n\n-- 7. Posts author + status composite for user activity filtering\n-- Optimizes: WHERE member_id = ? AND status_id = ?\nCREATE INDEX IF NOT EXISTS "idx_posts_member_status"\nON "posts" ("member_id", "status_id");--> statement-breakpoint\n\n-- 8. Post subscriptions muted filtering\n-- Optimizes: WHERE member_id = ? AND muted = false\nCREATE INDEX IF NOT EXISTS "idx_subscriptions_member_muted"\nON "post_subscriptions" ("member_id", "muted");\n',
  },
  {
    tag: '0006_add_comment_count_trigger',
    when: 1768688400000,
    hash: '9d432b42a3fd5a6c68ac420e5bb50f0c64b2576656a81d4fcb6c529e0de773b7',
    sql: "-- Migration: Add trigger to maintain denormalized comment_count on posts table\n-- This trigger automatically updates the comment_count when comments are inserted, deleted, or soft-deleted\n\n-- Function to update comment_count on the parent post\nCREATE OR REPLACE FUNCTION update_post_comment_count()\nRETURNS TRIGGER AS $$\nDECLARE\n  target_post_id uuid;\nBEGIN\n  -- Determine which post_id to update based on operation\n  IF TG_OP = 'DELETE' THEN\n    target_post_id := OLD.post_id;\n  ELSE\n    target_post_id := NEW.post_id;\n  END IF;\n\n  -- Update the comment count (only count non-deleted comments)\n  UPDATE posts\n  SET comment_count = (\n    SELECT COUNT(*)\n    FROM comments\n    WHERE comments.post_id = target_post_id\n      AND comments.deleted_at IS NULL\n  )\n  WHERE id = target_post_id;\n\n  RETURN COALESCE(NEW, OLD);\nEND;\n$$ LANGUAGE plpgsql;--> statement-breakpoint\n\n-- Trigger for INSERT operations\nCREATE TRIGGER trg_comment_insert_update_count\n  AFTER INSERT ON comments\n  FOR EACH ROW\n  EXECUTE FUNCTION update_post_comment_count();--> statement-breakpoint\n\n-- Trigger for DELETE operations (hard delete)\nCREATE TRIGGER trg_comment_delete_update_count\n  AFTER DELETE ON comments\n  FOR EACH ROW\n  EXECUTE FUNCTION update_post_comment_count();--> statement-breakpoint\n\n-- Trigger for UPDATE operations (handles soft delete via deleted_at)\nCREATE TRIGGER trg_comment_update_update_count\n  AFTER UPDATE OF deleted_at ON comments\n  FOR EACH ROW\n  WHEN (OLD.deleted_at IS DISTINCT FROM NEW.deleted_at)\n  EXECUTE FUNCTION update_post_comment_count();--> statement-breakpoint\n\n-- Backfill existing posts with correct comment counts\n-- This ensures all existing data is accurate after the trigger is created\nUPDATE posts\nSET comment_count = (\n  SELECT COUNT(*)\n  FROM comments\n  WHERE comments.post_id = posts.id\n    AND comments.deleted_at IS NULL\n);\n",
  },
  {
    tag: '0007_subscription_notification_levels',
    when: 1768774800000,
    hash: 'f5a8f719a3d7c8afa7f2d694cb654a982a9974c7749e6c77ef54c277a31b3cdf',
    sql: '-- Migration: Add granular notification controls to post_subscriptions\n--\n-- This replaces the boolean `muted` column with two separate columns:\n-- - notify_comments: receive notifications for new comments\n-- - notify_status_changes: receive notifications for status changes\n--\n-- "All activity" = both true\n-- "Status changes only" = notify_comments=false, notify_status_changes=true\n-- "Unsubscribed" = row deleted\n\n-- Step 1: Add new columns with defaults\nALTER TABLE "post_subscriptions"\nADD COLUMN "notify_comments" boolean DEFAULT true NOT NULL,\nADD COLUMN "notify_status_changes" boolean DEFAULT true NOT NULL;--> statement-breakpoint\n\n-- Step 2: Migrate data from muted column\n-- If muted=true, set both to false (was silencing all notifications)\n-- If muted=false, keep both as true (default - all notifications)\nUPDATE "post_subscriptions"\nSET "notify_comments" = NOT "muted",\n    "notify_status_changes" = NOT "muted";--> statement-breakpoint\n\n-- Step 3: Drop old index and column\nDROP INDEX IF EXISTS "post_subscriptions_post_active_idx";--> statement-breakpoint\nALTER TABLE "post_subscriptions" DROP COLUMN "muted";--> statement-breakpoint\n\n-- Step 4: Create new partial indexes for efficient subscriber lookups\nCREATE INDEX "post_subscriptions_post_comments_idx"\nON "post_subscriptions" ("post_id")\nWHERE notify_comments = true;--> statement-breakpoint\n\nCREATE INDEX "post_subscriptions_post_status_idx"\nON "post_subscriptions" ("post_id")\nWHERE notify_status_changes = true;\n',
  },
  {
    tag: '0008_add_pinned_comment',
    when: 1768861200000,
    hash: '89ecb1ec49a91740ca3cac21960dfb1c2aeec77d1529905dc52abaf7e80eeba0',
    sql: '-- Migration: Add pinned comment support\n-- This allows pinning a team member\'s comment as the official response\n\n-- Add pinned_comment_id column to posts table\nALTER TABLE "posts" ADD COLUMN "pinned_comment_id" uuid;--> statement-breakpoint\n\n-- Add index for efficient lookups\nCREATE INDEX "posts_pinned_comment_id_idx" ON "posts" ("pinned_comment_id");\n\n-- Note: We intentionally don\'t add a foreign key constraint here to avoid\n-- circular dependency issues. The application layer handles validation.\n-- The column references comments.id but we rely on application logic to\n-- maintain referential integrity (similar to how parentId works in comments).\n',
  },
  {
    tag: '0009_add_setup_state',
    when: 1768947600000,
    hash: '9ba98678592f2ee1c5332e7fe98a193e0b34e6cb9f2276ce97f1dd2b51d8a949',
    sql: '-- Add setup_state column for tracking onboarding/provisioning state\nALTER TABLE "settings" ADD COLUMN "setup_state" text;\n',
  },
  {
    tag: '0010_add_board_vote_desc_index',
    when: 1769034000000,
    hash: '203e45e671430bf2bbeba4a0718368ec890298f17acc2da949c13427cbc40692',
    sql: '-- Optimized indexes for "top posts" and "new posts" queries that ORDER BY DESC\n-- The existing posts_board_vote_idx is ascending, requiring backward scans\n-- These DESC indexes allow PostgreSQL to scan from highest values, stopping early after LIMIT\n-- Note: Cannot use CONCURRENTLY because Drizzle migrations run in transactions\n\n-- Index for vote_count DESC (used by "top" sort)\nCREATE INDEX IF NOT EXISTS "posts_board_vote_desc_idx"\nON "posts" ("board_id", "vote_count" DESC);--> statement-breakpoint\n\n-- Index for created_at DESC (used by "new" sort)\nCREATE INDEX IF NOT EXISTS "posts_board_created_desc_idx"\nON "posts" ("board_id", "created_at" DESC);\n',
  },
  {
    tag: '0011_drop_deprecated_billing',
    when: 1769120400000,
    hash: '92c6c26a318cec654982421150f3839c155fc075142a3be7e9f77ef4f0dbee8c',
    sql: '-- Migration: Drop deprecated billing tables from tenant database\n--\n-- Billing has been moved to the catalog database (website codebase).\n-- These tables were created in migration 0003 but are no longer used.\n-- The subscription table in the catalog database now handles all billing.\n\n-- Drop tables\nDROP TABLE IF EXISTS "invoices";--> statement-breakpoint\nDROP TABLE IF EXISTS "billing_subscriptions";--> statement-breakpoint\n\n-- Drop indexes (if any remain after table drop)\nDROP INDEX IF EXISTS "subscriptions_stripe_customer_idx";--> statement-breakpoint\nDROP INDEX IF EXISTS "subscriptions_stripe_subscription_idx";--> statement-breakpoint\nDROP INDEX IF EXISTS "invoices_stripe_invoice_idx";--> statement-breakpoint\n\n-- Drop enums (order matters - must drop after tables that use them)\nDROP TYPE IF EXISTS "invoice_status";--> statement-breakpoint\nDROP TYPE IF EXISTS "subscription_status";--> statement-breakpoint\nDROP TYPE IF EXISTS "cloud_tier";\n',
  },
  {
    tag: '0012_add_public_indexes',
    when: 1769206800000,
    hash: '12df9ffa7c6b30609f082da543eedd45f9301d5c00d7f4464da4c74b1f5ad48a',
    sql: '-- Add indexes for public filtering (used by all portal queries)\n-- These indexes optimize WHERE is_public = true conditions\n\nCREATE INDEX IF NOT EXISTS "boards_is_public_idx" ON "boards" ("is_public");\nCREATE INDEX IF NOT EXISTS "roadmaps_is_public_idx" ON "roadmaps" ("is_public");\n',
  },
  {
    tag: '0013_authenticated_voting',
    when: 1769293200000,
    hash: '8708d0ffd2ea1529e7ce17a162edab694d5e5f8e235b6f9ff75a69eb4b6d23f5',
    sql: '-- Migration: Require authentication for voting and reactions\n-- This removes anonymous voting support and makes member_id required\n\n-- ============================================\n-- VOTES TABLE\n-- ============================================\n\n-- Step 1: Add member_id column as UUID (nullable first for migration)\nALTER TABLE "votes" ADD COLUMN IF NOT EXISTS "member_id" uuid;\n\n-- Step 2: Delete any existing anonymous votes (votes without member_id)\nDELETE FROM "votes" WHERE "member_id" IS NULL;\n\n-- Step 3: Make member_id NOT NULL\nALTER TABLE "votes" ALTER COLUMN "member_id" SET NOT NULL;\n\n-- Step 4: Add foreign key if not exists (idempotent)\nDO $$\nBEGIN\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_constraint WHERE conname = \'votes_member_id_member_id_fk\'\n  ) THEN\n    ALTER TABLE "votes" ADD CONSTRAINT "votes_member_id_member_id_fk"\n      FOREIGN KEY ("member_id") REFERENCES "public"."member"("id") ON DELETE cascade ON UPDATE no action;\n  END IF;\nEND $$;\n\n-- Step 5: Drop old user_identifier column and its index\nDROP INDEX IF EXISTS "votes_unique_idx";\nALTER TABLE "votes" DROP COLUMN IF EXISTS "user_identifier";\n\n-- Step 6: Create new unique index on (post_id, member_id)\nCREATE UNIQUE INDEX IF NOT EXISTS "votes_member_post_idx" ON "votes" USING btree ("post_id", "member_id");\n\n-- Step 7: Create index for member lookups\nCREATE INDEX IF NOT EXISTS "votes_member_id_idx" ON "votes" USING btree ("member_id");\nCREATE INDEX IF NOT EXISTS "votes_member_created_at_idx" ON "votes" USING btree ("member_id", "created_at");\n\n-- ============================================\n-- COMMENT_REACTIONS TABLE\n-- ============================================\n\n-- Step 1: Add member_id column as UUID (nullable first for migration)\nALTER TABLE "comment_reactions" ADD COLUMN IF NOT EXISTS "member_id" uuid;\n\n-- Step 2: Delete any existing anonymous reactions (reactions without member_id)\nDELETE FROM "comment_reactions" WHERE "member_id" IS NULL;\n\n-- Step 3: Make member_id NOT NULL\nALTER TABLE "comment_reactions" ALTER COLUMN "member_id" SET NOT NULL;\n\n-- Step 4: Add foreign key if not exists (idempotent)\nDO $$\nBEGIN\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_constraint WHERE conname = \'comment_reactions_member_id_member_id_fk\'\n  ) THEN\n    ALTER TABLE "comment_reactions" ADD CONSTRAINT "comment_reactions_member_id_member_id_fk"\n      FOREIGN KEY ("member_id") REFERENCES "public"."member"("id") ON DELETE cascade ON UPDATE no action;\n  END IF;\nEND $$;\n\n-- Step 5: Drop old user_identifier column and its index\nDROP INDEX IF EXISTS "comment_reactions_unique_idx";\nALTER TABLE "comment_reactions" DROP COLUMN IF EXISTS "user_identifier";\n\n-- Step 6: Create new unique index on (comment_id, member_id, emoji)\nCREATE UNIQUE INDEX IF NOT EXISTS "comment_reactions_unique_idx" ON "comment_reactions" USING btree ("comment_id", "member_id", "emoji");\n\n-- Step 7: Create index for member lookups\nCREATE INDEX IF NOT EXISTS "comment_reactions_member_id_idx" ON "comment_reactions" USING btree ("member_id");\n',
  },
]

/**
 * Schema version identifier (tag of last migration)
 */
export const SCHEMA_VERSION = '0013_authenticated_voting'

/**
 * Parse a migration SQL into individual statements.
 * Splits on drizzle-kit's breakpoint marker and filters empty/comment-only blocks.
 */
export function parseStatements(sql: string): string[] {
  return sql
    .split('--> statement-breakpoint')
    .map((s) => s.trim())
    .filter((s) => {
      if (s.length === 0) return false
      // Check if block contains any actual SQL (not just comments)
      const lines = s.split('\n')
      return lines.some((line) => {
        const trimmed = line.trim()
        return trimmed.length > 0 && !trimmed.startsWith('--')
      })
    })
}

/**
 * SQL to create the drizzle migrations tracking table.
 * This must be run before recording migrations.
 */
export const CREATE_MIGRATIONS_TABLE_SQL = `
CREATE SCHEMA IF NOT EXISTS drizzle;
CREATE TABLE IF NOT EXISTS drizzle.__drizzle_migrations (
  id SERIAL PRIMARY KEY,
  hash TEXT NOT NULL,
  created_at BIGINT NOT NULL
);
`

/**
 * SQL to insert a migration record.
 * Use with parameterized query: (hash, created_at)
 */
export const INSERT_MIGRATION_SQL = `
INSERT INTO drizzle.__drizzle_migrations (hash, created_at) VALUES ($1, $2)
`

/**
 * SQL to check which migrations have been applied.
 * Returns array of hashes.
 */
export const GET_APPLIED_MIGRATIONS_SQL = `
SELECT hash FROM drizzle.__drizzle_migrations
`

/**
 * Seed SQL for default post statuses.
 * Run after migrations to populate initial data.
 */
export const SEED_SQL = `INSERT INTO "post_statuses" ("id", "name", "slug", "color", "category", "position", "show_on_roadmap", "is_default", "created_at")
VALUES
  (uuidv7(), 'Open', 'open', '#3b82f6', 'active', 0, false, true, NOW()),
  (uuidv7(), 'Under Review', 'under_review', '#eab308', 'active', 1, false, false, NOW()),
  (uuidv7(), 'Planned', 'planned', '#a855f7', 'active', 2, true, false, NOW()),
  (uuidv7(), 'In Progress', 'in_progress', '#f97316', 'active', 3, true, false, NOW()),
  (uuidv7(), 'Complete', 'complete', '#22c55e', 'complete', 0, true, false, NOW()),
  (uuidv7(), 'Closed', 'closed', '#6b7280', 'closed', 0, false, false, NOW());`
