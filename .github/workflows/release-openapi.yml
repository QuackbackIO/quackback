name: Release OpenAPI Spec

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to attach openapi.json to (e.g. v0.3.6)'
        required: true

permissions:
  contents: write

jobs:
  publish-openapi:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate OpenAPI spec
        run: |
          cat << 'EOF' > generate-openapi.ts
          import { writeFileSync } from 'node:fs';
          import { generateOpenAPISpec } from './apps/web/src/lib/server/domains/api/openapi';
          import './apps/web/src/lib/server/domains/api/schemas';

          const spec = generateOpenAPISpec();
          writeFileSync('openapi.json', JSON.stringify(spec, null, 2));
          console.log('OpenAPI spec generated as openapi.json');
          EOF
          bun run generate-openapi.ts

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.event.release.tag_name }}
          files: openapi.json
